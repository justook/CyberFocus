<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberFocus ä¸ªäººä¸­æ§å°</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        /* åŸæœ‰CSSæ ·å¼ä¿æŒä¸å˜ */
        :root {
            --primary: #00f2ea;
            --accent: #ff0050;
            --success: #31c27c;
            --text-main: #fff;
            --text-sec: #aaa;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --backdrop: blur(10px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background: #0f0c29;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: var(--text-main);
            min-height: 100vh;
            padding: 20px;
        }

        /* èƒŒæ™¯åŠ¨ç”» */
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* èƒŒæ™¯è£…é¥°å…‰æ–‘ */
        .bg-blob {
            position: fixed;
            border-radius: 50%;
            filter: blur(80px);
            z-index: -1;
            opacity: 0.6;
            animation: float 10s infinite alternate;
        }
        .blob-1 { width: 300px; height: 300px; background: #302b63; top: -50px; left: -50px; }
        .blob-2 { width: 400px; height: 400px; background: #24243e; bottom: -100px; right: -100px; animation-delay: -5s; }

        @keyframes float {
            0% { transform: translate(0, 0); }
            100% { transform: translate(30px, 50px); }
        }

        /* --- å¸ƒå±€å®¹å™¨ --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr 320px;
            gap: 25px;
            grid-template-areas: 
                "header header header"
                "sidebar main extra";
        }

        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-areas: "header" "sidebar" "main" "extra";
            }
        }

        /* --- ç»ç’ƒæ‹Ÿæ€å¡ç‰‡ --- */
        .card {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: 0.3s;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 0 50px rgba(0, 242, 234, 0.3);
            transform: scale(0.8);
            transition: transform 0.3s ease;
            max-width: 400px;
            width: 90%;
        }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-content h2, .modal-content h3 { margin-bottom: 15px; color: var(--primary); justify-content: center; }
        .modal-content p { margin-bottom: 20px; color: #ddd; line-height: 1.6; }
        
        .input-group { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .input-group input { 
            width: 100%; padding: 12px; background: rgba(0,0,0,0.3); 
            border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff;
        }

        /* æ¨¡æ‹Ÿè¿›åº¦ç¯å…‰æ•ˆ */
        .timer-circle::after {
            content: ''; position: absolute; top: -5px; left: -5px; right: -5px; bottom: -5px;
            border-radius: 50%; border: 5px solid transparent; border-top-color: var(--accent);
            animation: spin 2s linear infinite;
            display: none; /* è¿è¡Œæ—¶æ˜¾ç¤º */
        }
        .timer-circle.active::after { display: block; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .time-display { font-size: 42px; font-weight: 700; font-family: monospace; }

        .pomo-controls { margin-top: 20px; display: flex; justify-content: center; gap: 15px; }
        
        button {
            border: none; padding: 10px 24px; border-radius: 30px; cursor: pointer;
            font-weight: 600; font-size: 14px; transition: 0.3s;
        }
        .btn-primary { background: var(--primary); color: #000; box-shadow: 0 0 10px rgba(0, 242, 234, 0.4); }
        .btn-primary:hover { transform: scale(1.05); background: #fff; }
        .btn-sec { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-sec:hover { background: rgba(255,255,255,0.2); }

        /* --- 3. ä¸»å†…å®¹ (ToDo) å¢å¼ºç‰ˆ --- */
        .main-content { grid-area: main; }
        
        /* æ ‡ç­¾é¡µ */
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 12px; }
        .tab-btn {
            flex: 1; text-align: center; padding: 10px; cursor: pointer;
            border-radius: 8px; color: var(--text-sec); transition: 0.3s; font-size: 14px;
        }
        .tab-btn.active { background: rgba(255,255,255,0.1); color: var(--text-main); font-weight: bold; }

        /* ä»»åŠ¡è¾“å…¥åŒº */
        .task-input-container {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* æ–°å¢ï¼šæ‹–æ‹½ç›¸å…³æ ·å¼ */
        .todo-list {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 5px;
            min-height: 50px; /* ç¡®ä¿æœ‰æ‹–æ”¾åŒºåŸŸ */
        }
        
        .todo-item {
            background: rgba(255,255,255,0.02);
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 10px;
            transition: 0.2s;
            border-left: 3px solid transparent;
            display: flex;
            flex-direction: column;
            cursor: grab; /* æ‹–æ‹½å…‰æ ‡ */
            user-select: none; /* é˜²æ­¢é€‰ä¸­æ–‡æœ¬ */
            position: relative;
        }
        
        .todo-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
            border: 2px dashed var(--primary);
            background: rgba(0, 242, 234, 0.1);
        }
        
        .todo-item.drag-over {
            border-top: 2px solid var(--accent);
            margin-top: 15px;
            transform: translateY(5px);
        }
        
        .drag-handle {
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-sec);
            cursor: grab;
            opacity: 0.3;
            transition: opacity 0.3s;
            padding: 5px;
            border-radius: 4px;
        }
        
        .todo-item:hover .drag-handle {
            opacity: 0.8;
        }
        
        .drag-handle:hover {
            color: var(--primary);
            background: rgba(255,255,255,0.1);
        }
        
        /* å®Œæˆç®±å­æ ·å¼ */
        .completed-box {
            margin-top: 20px;
            background: linear-gradient(180deg, rgba(31, 194, 124, 0.05) 0%, rgba(31, 194, 124, 0.02) 100%);
            border: 1px solid rgba(31, 194, 124, 0.2);
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s ease;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .completed-box.collapsed {
            max-height: 50px;
            overflow: hidden;
        }
        
        .completed-box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
        }
        
        .completed-box-header h4 {
            color: var(--success);
            font-size: 14px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .collapse-btn {
            background: none;
            border: none;
            color: var(--text-sec);
            cursor: pointer;
            transition: 0.3s;
            padding: 5px;
        }
        
        .collapse-btn:hover {
            color: var(--success);
            transform: rotate(90deg);
        }
        
        .completed-item {
            background: rgba(255,255,255,0.02);
            border-left: 3px solid var(--success);
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .completed-text {
            color: var(--text-sec);
            text-decoration: line-through;
            flex: 1;
        }
        
        .completed-time {
            font-size: 11px;
            color: #666;
            background: rgba(0,0,0,0.3);
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 10px;
        }
        
        .empty-completed {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
            font-size: 13px;
        }
        
        .clear-completed-btn {
            background: rgba(255, 0, 80, 0.1);
            border: 1px solid rgba(255, 0, 80, 0.3);
            color: var(--accent);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
            display: inline-block;
        }
        
        .clear-completed-btn:hover {
            background: rgba(255, 0, 80, 0.2);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <!-- èƒŒæ™¯è£…é¥° -->
    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>

    <div class="container">
        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <div class="card" style="min-height: 100%;">
                <h3><span class="title-text">ğŸ“ ä»»åŠ¡è®¡åˆ’</span></h3>
                <div class="tabs">
                    <div class="tab-btn active" onclick="switchTab('todo')">å¾…åŠäº‹é¡¹</div>
                    <div class="tab-btn" onclick="switchTab('day')">ä»Šæ—¥è®¡åˆ’</div>
                    <div class="tab-btn" onclick="switchTab('week')">æœ¬å‘¨ç›®æ ‡</div>
                    <div class="tab-btn" onclick="switchTab('completed')">æœ¬å‘¨å®Œæˆ</div>
                </div>
                
                <!-- å¾…åŠäº‹é¡¹è¾“å…¥åŒºåŸŸ -->
                <div class="task-input-container" id="taskInputContainer">
                    <div class="input-row">
                        <input type="text" id="todoInput" placeholder="è¾“å…¥ä»»åŠ¡å†…å®¹..." onkeypress="handleEnter(event)">
                        <button class="btn-primary" onclick="addTodo()">+</button>
                    </div>
                    <div class="input-row" style="align-items: center;">
                        <input type="datetime-local" id="deadlineInput" title="æˆªæ­¢æ—¶é—´" placeholder="æˆªæ­¢æ—¶é—´">
                        <select id="parentSelect" style="flex: 1; max-width: 150px;" onchange="toggleContributionInput()">
                            <option value="">æ— å…³è”ç›®æ ‡</option>
                            <!-- JS åŠ¨æ€å¡«å…… -->
                        </select>
                        <input type="number" id="contributionInput" placeholder="å æ¯”%" min="1" max="100" title="å®Œæˆè¯¥ä»»åŠ¡å¯ä¸ºçˆ¶ä»»åŠ¡å¢åŠ å¤šå°‘ç™¾åˆ†æ¯”è¿›åº¦">
                    </div>
                </div>

                <!-- å¾…åŠäº‹é¡¹åˆ—è¡¨ -->
                <ul class="todo-list" id="todoList">
                    <!-- JS ç”Ÿæˆ -->
                </ul>
                
                <!-- æœ¬å‘¨å®Œæˆç®±å­ -->
                <div class="completed-box collapsed" id="completedBox">
                    <div class="completed-box-header" onclick="toggleCompletedBox()">
                        <h4><i class="ph-fill ph-check-circle"></i> æœ¬å‘¨å·²å®Œæˆçš„ä»»åŠ¡</h4>
                        <button class="collapse-btn">
                            <i class="ph-bold ph-caret-down" id="collapseIcon"></i>
                        </button>
                    </div>
                    <div id="completedList">
                        <!-- å·²å®Œæˆä»»åŠ¡åˆ—è¡¨ -->
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <button class="clear-completed-btn" onclick="clearCompletedTasks()">
                            <i class="ph-bold ph-trash"></i> æ¸…ç©ºå·²å®Œæˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¿«æ·æ–¹å¼æ¨¡æ€æ¡† -->
    <div id="shortcutModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="shortcutModalTitle">ğŸ”— æ·»åŠ å¿«æ·æ–¹å¼</h3>
            <div class="input-group">
                <input type="text" id="scTitle" placeholder="åç§° (å¦‚: ç™¾åº¦)">
                <input type="text" id="scUrl" placeholder="ç½‘å€ (å¦‚: https://...)">
            </div>
            <button class="btn-primary" onclick="saveShortcut()" style="width: 100%">ä¿å­˜</button>
            <button class="btn-sec" onclick="closeShortcutModal()" style="margin-top: 10px; width: 100%">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- ä¸“æ³¨æ—¶åˆ»åŒºåŸŸ -->
    <div class="card pomodoro-container">
        <h3><span class="title-text">â³ ä¸“æ³¨æ—¶åˆ»</span></h3>
        <div class="timer-circle" id="pomoCircle">
            <div class="time-display" id="timer">25:00</div>
        </div>
        <div class="timer-settings" id="timerSettings">
            <span class="setting-label">è®¾ç½®æ—¶é•¿(åˆ†):</span>
            <input type="number" id="customMinutes" value="25" min="1" max="120" onchange="updateCustomTime()" oninput="updateCustomTime()">
        </div>
        <div class="pomo-controls">
            <button class="btn-primary" id="startBtn" onclick="toggleTimer()">START</button>
            <button class="btn-sec" onclick="resetTimer()">RESET</button>
        </div>
    </div>

    <!-- ç»Ÿè®¡æ¨¡æ€æ¡† -->
    <div id="statModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 300px;">
            <h3>âœï¸ ä¿®æ”¹ä»Šæ—¥æ—¶é•¿</h3>
            <p style="font-size:12px; color:#aaa;">è¾“å…¥ä»Šæ—¥å·²ä¸“æ³¨çš„æ€»åˆ†é’Ÿæ•°</p>
            <input type="number" id="manualStatInput" placeholder="åˆ†é’Ÿ" style="width:100%; padding:10px; margin:10px 0; background:rgba(0,0,0,0.3); border:1px solid #444; color:#fff; border-radius:8px; text-align:center; font-size:18px;">
            <button class="btn-primary" onclick="saveManualStat()" style="width:100%">ä¿å­˜</button>
            <button class="btn-sec" onclick="closeStatModal()" style="margin-top:10px; width:100%">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // --- æ‹–æ‹½æ’åºåŠŸèƒ½ ---
        let dragSource = null;
        
        // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
        function initDragAndDrop() {
            const todoList = document.getElementById('todoList');
            
            // ä¸ºç°æœ‰é¡¹ç›®æ·»åŠ æ‹–æ‹½äº‹ä»¶
            addDragEventsToList(todoList);
            
            // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æ–°æ·»åŠ çš„é¡¹ç›®
            todoList.addEventListener('mousedown', (e) => {
                const item = e.target.closest('.todo-item:not(.done)');
                if (item && !item.hasAttribute('draggable')) {
                    setupDragItem(item);
                }
            });
        }
        
        // ä¸ºåˆ—è¡¨æ·»åŠ æ‹–æ‹½äº‹ä»¶
        function addDragEventsToList(list) {
            const items = list.querySelectorAll('.todo-item:not(.done)');
            items.forEach(item => setupDragItem(item));
        }
        
        // ä¸ºå•ä¸ªé¡¹ç›®è®¾ç½®æ‹–æ‹½
        function setupDragItem(item) {
            item.setAttribute('draggable', true);
            item.addEventListener('dragstart', handleDragStart);
            item.addEventListener('dragover', handleDragOver);
            item.addEventListener('dragenter', handleDragEnter);
            item.addEventListener('dragleave', handleDragLeave);
            item.addEventListener('drop', handleDrop);
            item.addEventListener('dragend', handleDragEnd);
        }
        
        // æ‹–æ‹½å¼€å§‹
        function handleDragStart(e) {
            if (!e.target.closest('.todo-item') || e.target.closest('.todo-item').classList.contains('done')) {
                e.preventDefault();
                return;
            }
            
            dragSource = e.target.closest('.todo-item');
            dragSource.classList.add('dragging');
            
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', dragSource.dataset.id || '');
            
            setTimeout(() => {
                dragSource.classList.add('dragging');
            }, 0);
        }
        
        // æ‹–æ‹½ç»è¿‡
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        // æ‹–æ‹½è¿›å…¥
        function handleDragEnter(e) {
            const targetItem = e.target.closest('.todo-item');
            if (targetItem && targetItem !== dragSource && !targetItem.classList.contains('done')) {
                targetItem.classList.add('drag-over');
            }
        }
        
        // æ‹–æ‹½ç¦»å¼€
        function handleDragLeave(e) {
            const targetItem = e.target.closest('.todo-item');
            if (targetItem) {
                targetItem.classList.remove('drag-over');
            }
        }
        
        // æ”¾ç½®
        function handleDrop(e) {
            e.preventDefault();
            
            const targetItem = e.target.closest('.todo-item');
            if (!targetItem || !dragSource || targetItem === dragSource || targetItem.classList.contains('done')) {
                return;
            }
            
            // ç§»é™¤æ‰€æœ‰é«˜äº®
            document.querySelectorAll('.todo-item.drag-over').forEach(item => {
                item.classList.remove('drag-over');
            });
            
            // è·å–åˆ—è¡¨
            const todoList = document.getElementById('todoList');
            const items = Array.from(todoList.querySelectorAll('.todo-item:not(.done)'));
            
            // è·å–æºç´¢å¼•å’Œç›®æ ‡ç´¢å¼•
            const sourceIndex = items.indexOf(dragSource);
            const targetIndex = items.indexOf(targetItem);
            
            if (sourceIndex !== -1 && targetIndex !== -1) {
                // é‡æ–°æ’åºæ•°ç»„
                const tasksToShow = allTasks.filter(t => t.type === currentTab && !t.done);
                
                // æ‰¾å‡ºæºä»»åŠ¡å’Œç›®æ ‡ä»»åŠ¡åœ¨allTasksä¸­çš„ç´¢å¼•
                const sourceTaskId = dragSource.dataset.id;
                const targetTaskId = targetItem.dataset.id;
                
                const sourceTaskIndex = allTasks.findIndex(t => t.id === sourceTaskId);
                const targetTaskIndex = allTasks.findIndex(t => t.id === targetTaskId);
                
                if (sourceTaskIndex !== -1 && targetTaskIndex !== -1) {
                    // é‡æ–°æ’åºï¼šå°†æºä»»åŠ¡ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®
                    const [movedTask] = allTasks.splice(sourceTaskIndex, 1);
                    allTasks.splice(targetTaskIndex, 0, movedTask);
                    
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    saveData();
                    
                    // é‡æ–°æ¸²æŸ“åˆ—è¡¨
                    renderList();
                }
            }
            
            return false;
        }
        
        // æ‹–æ‹½ç»“æŸ
        function handleDragEnd(e) {
            // ç§»é™¤æ‰€æœ‰é«˜äº®å’Œæ‹–æ‹½çŠ¶æ€
            document.querySelectorAll('.todo-item').forEach(item => {
                item.classList.remove('dragging', 'drag-over');
            });
            
            dragSource = null;
        }
        
        // --- å·²å®Œæˆç®±å­åŠŸèƒ½ ---
        let isCompletedBoxCollapsed = true;
        
        // åˆ‡æ¢å®Œæˆç®±å­çš„å±•å¼€/æŠ˜å 
        window.toggleCompletedBox = function() {
            const completedBox = document.getElementById('completedBox');
            const collapseIcon = document.getElementById('collapseIcon');
            
            isCompletedBoxCollapsed = !isCompletedBoxCollapsed;
            
            if (isCompletedBoxCollapsed) {
                completedBox.classList.add('collapsed');
                collapseIcon.className = 'ph-bold ph-caret-down';
            } else {
                completedBox.classList.remove('collapsed');
                collapseIcon.className = 'ph-bold ph-caret-up';
            }
        }
        
        // æ¸²æŸ“å·²å®Œæˆä»»åŠ¡
        function renderCompletedTasks() {
            const completedList = document.getElementById('completedList');
            const completedTasks = allTasks.filter(t => t.done && t.completedTime);
            
            // æŒ‰å®Œæˆæ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            completedTasks.sort((a, b) => new Date(b.completedTime) - new Date(a.completedTime));
            
            if (completedTasks.length === 0) {
                completedList.innerHTML = '<div class="empty-completed">æš‚æ— å·²å®Œæˆä»»åŠ¡</div>';
                return;
            }
            
            completedList.innerHTML = '';
            completedTasks.forEach(task => {
                const date = new Date(task.completedTime);
                const timeStr = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                const dateStr = date.toLocaleDateString('zh-CN');
                
                const li = document.createElement('div');
                li.className = 'completed-item';
                li.innerHTML = `
                    <span class="completed-text">${task.text}</span>
                    <span class="completed-time">${dateStr} ${timeStr}</span>
                    <button class="btn-sec" style="padding:3px 8px; margin-left:5px;" onclick="deleteTask('${task.id}', event)">
                        <i class="ph ph-trash"></i>
                    </button>
                `;
                completedList.appendChild(li);
            });
        }
        
        // æ¸…ç©ºå·²å®Œæˆä»»åŠ¡
        window.clearCompletedTasks = function() {
            if (!confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·²å®Œæˆä»»åŠ¡å—ï¼Ÿ")) return;
            
            allTasks = allTasks.filter(t => !t.done);
            saveData();
            renderCompletedTasks();
            renderList();
        }

        // --- é€šçŸ¥åŠŸèƒ½ ---
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--success);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 10000;
                animation: slideIn 0.3s ease;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            `;
            
            document.body.appendChild(notification);
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // æ·»åŠ CSSåŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // --- å¾…åŠäº‹é¡¹é€»è¾‘ ---
        let currentTab = 'todo';
        let allTasks = JSON.parse(localStorage.getItem('cyberTasks')) || [];
        if (!Array.isArray(allTasks)) allTasks = [];

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tab) {
            // æ›´æ–°æ ‡ç­¾é¡µæŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            currentTab = tab;
            
            // å¤„ç†ä»Šæ—¥è®¡åˆ’çš„è‡ªåŠ¨ Deadline
            const deadlineInput = document.getElementById('deadlineInput');
            if (tab === 'day') {
                const now = new Date();
                const yyyy = now.getFullYear();
                const mm = String(now.getMonth() + 1).padStart(2, '0');
                const dd = String(now.getDate()).padStart(2, '0');
                deadlineInput.value = `${yyyy}-${mm}-${dd}T23:59`;
            } else if (tab !== 'completed') {
                deadlineInput.value = '';
            }

            renderList();
            
            if (currentTab !== 'completed') {
                updateParentOptions(); 
                toggleContributionInput();
            }
        }

        // æ·»åŠ ä»»åŠ¡
        function addTodo() {
            const input = document.getElementById('todoInput');
            const deadlineInput = document.getElementById('deadlineInput');
            const parentSelect = document.getElementById('parentSelect');
            const contributionInput = document.getElementById('contributionInput');
            
            const text = input.value.trim();
            if (!text) return;
            
            const newTask = {
                id: Date.now().toString(),
                text: text,
                type: currentTab,
                done: false,
                deadline: deadlineInput.value,
                parentId: parentSelect.value || null,
                contribution: contributionInput.value ? parseInt(contributionInput.value) : null,
                legacyProgress: 0,
                completedTime: null // æ·»åŠ å®Œæˆæ—¶é—´å­—æ®µ
            };
            
            allTasks.unshift(newTask);
            
            // æ¸…ç©º
            input.value = '';
            if (currentTab !== 'day') deadlineInput.value = '';
            
            parentSelect.value = '';
            contributionInput.value = '';
            contributionInput.style.display = 'none';
            
            saveData();
            renderList();
            if (currentTab === 'week' || currentTab === 'day') {
                updateParentOptions(); 
            }
        }

        // å¤„ç†å›è½¦æ·»åŠ ä»»åŠ¡
        function handleEnter(event) {
            if (event.key === 'Enter') {
                addTodo();
            }
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderList() {
            const listEl = document.getElementById('todoList');
            const taskInputContainer = document.getElementById('taskInputContainer');
            const completedBox = document.getElementById('completedBox');
            
            // æ ¹æ®å½“å‰æ ‡ç­¾é¡µæ˜¾ç¤º/éšè—è¾“å…¥åŒºåŸŸå’Œå®Œæˆç®±å­
            if (currentTab === 'completed') {
                taskInputContainer.style.display = 'none';
                completedBox.style.display = 'block';
                renderCompletedTasks();
            } else {
                taskInputContainer.style.display = 'flex';
                completedBox.style.display = 'none';
            }
            
            // å¦‚æœä¸æ˜¯"æœ¬å‘¨å®Œæˆ"æ ‡ç­¾é¡µï¼Œæ˜¾ç¤ºæ­£å¸¸ä»»åŠ¡åˆ—è¡¨
            if (currentTab !== 'completed') {
                const tasksToShow = allTasks.filter(t => t.type === currentTab);
                
                tasksToShow.sort((a, b) => {
                    // é¦–å…ˆæŒ‰å®ŒæˆçŠ¶æ€æ’åºï¼ˆæœªå®Œæˆåœ¨å‰ï¼‰
                    if (a.done !== b.done) return a.done ? 1 : -1;
                    
                    // ç„¶åæŒ‰æˆªæ­¢æ—¶é—´æ’åº
                    if (!a.deadline) return 1;
                    if (!b.deadline) return -1;
                    return new Date(a.deadline) - new Date(b.deadline);
                });

                if (tasksToShow.length === 0) {
                    listEl.innerHTML = `<li style="text-align: center; padding: 20px; color: var(--text-sec);">
                        æš‚æ— ${currentTab === 'todo' ? 'å¾…åŠ' : currentTab === 'day' ? 'ä»Šæ—¥' : 'æœ¬å‘¨'}ä»»åŠ¡
                    </li>`;
                    return;
                }

                listEl.innerHTML = '';
                tasksToShow.forEach(item => {
                    // è®¡ç®—è¿›åº¦
                    let progress = 0;
                    const children = allTasks.filter(t => t.parentId === item.id);
                    const totalChild = children.length;
                    const legacy = item.legacyProgress || 0;
                    
                    if (totalChild > 0) {
                        const completedChild = children.filter(c => c.done).length;
                        if (completedChild > 0) {
                            let currentVal = legacy;
                            children.forEach(c => {
                                if (c.done) {
                                    const share = (c.contribution && parseInt(c.contribution) > 0) ? parseInt(c.contribution) : 100 / totalChild;
                                    currentVal += share;
                                }
                            });
                            progress = Math.min(100, Math.round(currentVal));
                        } else {
                            progress = legacy;
                        }
                    } else {
                        progress = item.done ? 100 : 0;
                    }
                    
                    const parentTask = item.parentId ? allTasks.find(t => t.id === item.parentId) : null;
                    const deadlineInfo = getDeadlineStatus(item.deadline, item.done);

                    const li = document.createElement('li');
                    const hasProgress = (totalChild > 0 || legacy > 0);
                    li.className = `todo-item ${item.done ? 'done' : ''} ${hasProgress ? 'has-progress' : ''}`;
                    li.dataset.id = item.id; // ä¸ºæ‹–æ‹½æ·»åŠ æ•°æ®æ ‡è¯†
                    
                    // é’ˆå¯¹å‘¨ä»»åŠ¡ï¼Œæ˜¾ç¤º"æ·»åŠ åˆ°ä»Šæ—¥"æŒ‰é’®
                    const showAddToDayBtn = (item.type === 'week' && !item.done);

                    li.innerHTML = `
                        <i class="ph ph-list drag-handle"></i>
                        <div class="item-main">
                            <input type="checkbox" class="custom-checkbox" ${item.done ? 'checked' : ''} onchange="toggleTask('${item.id}')">
                            <div style="flex:1;">
                                <div class="todo-text">
                                    ${item.text}
                                    ${parentTask ? `<span class="parent-badge">â†’ ${parentTask.text}</span>` : ''}
                                </div>
                                ${deadlineInfo ? `
                                    <span class="deadline-badge ${deadlineInfo.class}">
                                        <i class="ph ph-clock"></i> ${deadlineInfo.text}
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                        ${hasProgress ? `
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${progress}%"></div>
                                <span class="progress-text">${progress}%</span>
                            </div>
                        ` : ''}
                        <div class="item-actions">
                            ${showAddToDayBtn ? `
                                <button class="action-btn" title="æ·»åŠ åˆ°ä»Šæ—¥è®¡åˆ’" onclick="addToDay('${item.id}', event)">
                                    <i class="ph ph-calendar-plus"></i>
                                </button>
                            ` : ''}
                            <button class="action-btn" title="ç¼–è¾‘" onclick="editTask('${item.id}', event)">
                                <i class="ph ph-pencil"></i>
                            </button>
                            <button class="action-btn" title="åˆ é™¤" onclick="deleteTask('${item.id}', event)">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                    `;
                    listEl.appendChild(li);
                });
                
                // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
                setTimeout(() => addDragEventsToList(listEl), 0);
            }
        }

        // è·å–æˆªæ­¢æ—¥æœŸçŠ¶æ€
        function getDeadlineStatus(deadline, isDone) {
            if (!deadline || isDone) return null;
            
            const now = new Date();
            const deadlineDate = new Date(deadline);
            const diff = deadlineDate - now;
            
            // å°äº1å°æ—¶
            if (diff < 3600000 && diff > 0) {
                return { class: 'urgent', text: '1å°æ—¶å†…æˆªæ­¢' };
            }
            // å·²è¿‡æœŸ
            else if (diff < 0) {
                return { class: 'overdue', text: 'å·²è¿‡æœŸ' };
            }
            // 1-24å°æ—¶
            else if (diff < 86400000) {
                return { class: 'soon', text: 'ä»Šå¤©æˆªæ­¢' };
            }
            // 1-3å¤©
            else if (diff < 259200000) {
                return { class: 'warning', text: '3å¤©å†…æˆªæ­¢' };
            }
            
            return null;
        }

        // åˆ‡æ¢ä»»åŠ¡å®ŒæˆçŠ¶æ€
        window.toggleTask = function(id) {
            const task = allTasks.find(t => t.id === id);
            if (!task) return;

            task.done = !task.done;
            
            // è®°å½•å®Œæˆæ—¶é—´
            if (task.done && !task.completedTime) {
                task.completedTime = new Date().toISOString();
                showNotification('ä»»åŠ¡å·²å®Œæˆï¼');
            } else if (!task.done) {
                task.completedTime = null; // å¦‚æœå–æ¶ˆå®Œæˆï¼Œæ¸…é™¤å®Œæˆæ—¶é—´
            }
            
            // è”åŠ¨é€»è¾‘
            const children = allTasks.filter(t => t.parentId === id);
            if (task.done && children.length > 0) {
                children.forEach(c => {
                    c.done = true;
                    if (!c.completedTime) {
                        c.completedTime = new Date().toISOString();
                    }
                });
            }
            
            saveData();
            renderList();
            
            // æ›´æ–°å®Œæˆç®±å­
            if (currentTab === 'completed') {
                renderCompletedTasks();
            }
        };

        // åˆ é™¤ä»»åŠ¡
        window.deleteTask = function(id, event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            if(!confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) return;

            const taskIndex = allTasks.findIndex(t => t.id === id);
            if (taskIndex === -1) return;
            const task = allTasks[taskIndex];

            // é€»è¾‘æ›´æ–°
            if (task.parentId && task.done) {
                const parent = allTasks.find(p => p.id === task.parentId);
                if (parent) {
                    const siblings = allTasks.filter(t => t.parentId === task.parentId);
                    
                    let assignedPercent = 0;
                    let unassignedCount = 0;

                    siblings.forEach(c => {
                        if (c.contribution && parseInt(c.contribution) > 0) {
                            assignedPercent += parseInt(c.contribution);
                        } else {
                            unassignedCount++;
                        }
                    });

                    const base = parent.legacyProgress || 0;
                    const remainingPercent = Math.max(0, 100 - base - assignedPercent);
                    const defaultShare = unassignedCount > 0 ? (remainingPercent / unassignedCount) : 0;
                    
                    const effectiveContribution = (task.contribution && parseInt(task.contribution) > 0) 
                        ? parseInt(task.contribution) 
                        : defaultShare;
                    
                    parent.legacyProgress = (parent.legacyProgress || 0) + effectiveContribution;
                    if (parent.legacyProgress > 100) parent.legacyProgress = 100;
                }
            }
            
            allTasks.splice(taskIndex, 1);
            
            allTasks.forEach(t => {
                if (t.parentId === id) t.parentId = null;
            });

            saveData();
            renderList();
            updateParentOptions();
            
            // æ›´æ–°å®Œæˆç®±å­
            if (currentTab === 'completed') {
                renderCompletedTasks();
            }
        };

        // æ›´æ–°"å…³è”ç›®æ ‡"çš„ä¸‹æ‹‰é€‰é¡¹
        function updateParentOptions() {
            const select = document.getElementById('parentSelect');
            const currentVal = select.value;
            select.innerHTML = '<option value="">æ— å…³è”ç›®æ ‡</option>';
            
            let parents = [];
            if (currentTab === 'todo') {
                parents = allTasks.filter(t => (t.type === 'week' || t.type === 'day') && !t.done);
            } else if (currentTab === 'day') {
                parents = allTasks.filter(t => t.type === 'week' && !t.done);
            }

            parents.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = `[${p.type === 'week' ? 'å‘¨' : 'æ—¥'}] ${p.text}`;
                select.appendChild(opt);
            });
            
            // å°è¯•ä¿æŒä¹‹å‰é€‰ä¸­çš„å€¼
            select.value = currentVal;
        }

        // åˆ‡æ¢è´¡çŒ®å€¼è¾“å…¥æ¡†æ˜¾ç¤º
        function toggleContributionInput() {
            const parentSelect = document.getElementById('parentSelect');
            const contributionInput = document.getElementById('contributionInput');
            
            if (parentSelect.value) {
                contributionInput.style.display = 'block';
            } else {
                contributionInput.style.display = 'none';
                contributionInput.value = '';
            }
        }

        // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveData() {
            localStorage.setItem('cyberTasks', JSON.stringify(allTasks));
        }

        // --- å‘¨ç›®æ ‡æ·»åŠ åˆ°ä»Šæ—¥è®¡åˆ’ ---
        window.addToDay = function(parentId, event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }

            const parentTask = allTasks.find(t => t.id === parentId);
            if (!parentTask) return;

            // è®¡ç®—å½“å‰å·²åˆ†é…çš„ç™¾åˆ†æ¯”ï¼Œç»™å‡ºé»˜è®¤å»ºè®®
            const children = allTasks.filter(t => t.parentId === parentId);
            let assignedPercent = 0;
            children.forEach(c => {
                 if (c.contribution) assignedPercent += parseInt(c.contribution);
            });
            const legacy = parentTask.legacyProgress || 0;
            const remaining = Math.max(0, 100 - legacy - assignedPercent);

            const percentStr = prompt(`å°†ã€${parentTask.text}ã€‘æ’å…¥ä»Šæ—¥è®¡åˆ’ã€‚\nè¯·è¾“å…¥å®Œæˆæ­¤é¡¹å·¥ä½œå¯ä¸ºå‘¨ç›®æ ‡è´¡çŒ®çš„è¿›åº¦ç™¾åˆ†æ¯”ï¼ˆå‰©ä½™å¯ç”¨ï¼š${Math.round(remaining)}%ï¼‰ï¼š`, Math.round(remaining));
            
            if (percentStr === null) return; // å–æ¶ˆ
            const percent = parseInt(percentStr);
            if (isNaN(percent) || percent < 0 || percent > 100) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ 0-100 æ•°å­—");
                return;
            }

            const nameStr = prompt("è¯·è¾“å…¥ä»Šæ—¥è®¡åˆ’çš„ä»»åŠ¡åç§°ï¼š", parentTask.text);
            if (nameStr === null) return; // å–æ¶ˆ
            const taskName = nameStr.trim() || parentTask.text;

            // è‡ªåŠ¨è®¾ç½® Deadline ä¸ºä»Šå¤© 23:59
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const deadlineToday = `${yyyy}-${mm}-${dd}T23:59`;

            const newTask = {
                id: Date.now().toString(),
                text: taskName,
                type: 'day',
                done: false,
                deadline: deadlineToday,
                parentId: parentTask.id,
                contribution: percent
            };

            allTasks.unshift(newTask);
            saveData();
            renderList();
            updateParentOptions();
            
            // ç®€å•åé¦ˆ
            const btn = event.target.closest('.action-btn');
            const originalColor = btn.style.color;
            btn.style.color = '#31c27c';
            setTimeout(() => { btn.style.color = originalColor; }, 1000);
        };

        // --- å¿«æ·æ–¹å¼ç®¡ç† ---
        let shortcuts = JSON.parse(localStorage.getItem('cyberShortcuts')) || [
            { title: 'GitHub', url: 'https://github.com' },
            { title: 'Google', url: 'https://google.com' }
        ];
        let currentEditingIndex = -1;
        let isShortcutEditMode = false;

        function renderShortcuts() {
            const container = document.getElementById('shortcutsContainer');
            container.innerHTML = '';
            
            shortcuts.forEach((sc, index) => {
                const item = document.createElement('a');
                item.href = sc.url;
                item.target = '_blank';
                item.className = 'shortcut-item';
                item.innerHTML = `
                    <span>${sc.title}</span>
                    ${isShortcutEditMode ? `
                        <div class="shortcut-actions">
                            <button onclick="openShortcutModal(${index})"><i class="ph ph-pencil"></i></button>
                            <button onclick="deleteShortcut(${index})"><i class="ph ph-trash"></i></button>
                        </div>
                    ` : ''}
                `;
                container.appendChild(item);
            });
            
            const editBtn = document.getElementById('editShortcutsBtn');
            editBtn.innerHTML = isShortcutEditMode ? 
                '<i class="ph ph-check"></i> å®Œæˆç¼–è¾‘' : 
                '<i class="ph ph-pencil"></i> ç¼–è¾‘å¿«æ·æ–¹å¼';
        }

        function toggleShortcutEditMode() {
            isShortcutEditMode = !isShortcutEditMode;
            renderShortcuts();
        }

        function openShortcutModal(index) {
            currentEditingIndex = index;
            const modal = document.getElementById('shortcutModal');
            const titleInput = document.getElementById('scTitle');
            const urlInput = document.getElementById('scUrl');
            const modalTitle = document.getElementById('shortcutModalTitle');

            if (index === -1) {
                modalTitle.innerText = "ğŸ”— æ·»åŠ å¿«æ·æ–¹å¼";
                titleInput.value = "";
                urlInput.value = "";
            } else {
                modalTitle.innerText = "âš™ï¸ ä¿®æ”¹å¿«æ·æ–¹å¼";
                const sc = shortcuts[index];
                titleInput.value = sc.title;
                urlInput.value = sc.url;
            }
            modal.classList.add('show');
        }

        function closeShortcutModal() {
            document.getElementById('shortcutModal').classList.remove('show');
        }

        function saveShortcut() {
            const title = document.getElementById('scTitle').value.trim();
            let url = document.getElementById('scUrl').value.trim();
            
            if (!title || !url) {
                alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");
                return;
            }
            if (!url.startsWith('http')) {
                url = 'https://' + url;
            }

            if (currentEditingIndex === -1) {
                shortcuts.push({ title, url });
            } else {
                shortcuts[currentEditingIndex] = { title, url };
            }

            localStorage.setItem('cyberShortcuts', JSON.stringify(shortcuts));
            closeShortcutModal();
            renderShortcuts();
        }

        function deleteShortcut(index) {
            if (confirm("ç¡®å®šåˆ é™¤æ­¤å¿«æ·æ–¹å¼å—ï¼Ÿ")) {
                shortcuts.splice(index, 1);
                localStorage.setItem('cyberShortcuts', JSON.stringify(shortcuts));
                renderShortcuts();
            }
        }

        // --- æ—¶é’Ÿé€»è¾‘ ---
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-GB', { hour12: false });
            const dateStr = now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
            
            document.getElementById('clock').innerText = timeStr;
            document.getElementById('date').innerText = dateStr;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // --- ç•ªèŒ„é’Ÿé€»è¾‘ ---
        let timerInterval;
        let defaultTime = 25 * 60;
        let timeLeft = defaultTime;
        let isRunning = false;
        let audioCtx;
        
        // å†å²æ—¥å¿—æ•°æ®ç»“æ„ï¼š { "2023-11-01": 3600, "2023-11-02": 7200 }
        let focusHistory = JSON.parse(localStorage.getItem('cyberFocusHistory')) || {};
        
        // å…¼å®¹æ—§æ•°æ®è¿ç§»
        const oldDaily = JSON.parse(localStorage.getItem('cyberFocusStats'));
        if (oldDaily && oldDaily.date && oldDaily.totalSeconds > 0) {
            if (!focusHistory[oldDaily.date]) {
                focusHistory[oldDaily.date] = oldDaily.totalSeconds;
                localStorage.setItem('cyberFocusHistory', JSON.stringify(focusHistory));
            }
            localStorage.removeItem('cyberFocusStats');
        }

        function saveHistory() {
            localStorage.setItem('cyberFocusHistory', JSON.stringify(focusHistory));
        }
        
        // å¢åŠ ä»Šæ—¥æ—¶é•¿
        function addToHistory(seconds) {
            const today = new Date().toISOString().split('T')[0];
            if (!focusHistory[today]) focusHistory[today] = 0;
            focusHistory[today] += seconds;
            saveHistory();
            updateStatsUI();
            
            // è§¦å‘ UI åŠ¨ç”»
            const dashboard = document.getElementById('statsDashboard');
            dashboard.classList.remove('updated');
            void dashboard.offsetWidth; 
            dashboard.classList.add('updated');
        }

        // æ ¼å¼åŒ–æ—¶é—´è¾…åŠ©å‡½æ•°
        function formatTime(seconds) {
            if (seconds < 60) return "0m";
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            if (h > 0) return `${h}h ${String(m).padStart(2,'0')}m`;
            return `${m}m`;
        }
        
        // æ›´æ–°ç»Ÿè®¡ UI
        function updateStatsUI() {
            const todayStr = new Date().toISOString().split('T')[0];
            const currentMonth = todayStr.substring(0, 7);
            const currentYear = todayStr.substring(0, 4);
            
            let valToday = 0;
            let valMonth = 0;
            let valYear = 0;
            let valTotal = 0;
            
            for (const [date, seconds] of Object.entries(focusHistory)) {
                valTotal += seconds;
                if (date === todayStr) valToday += seconds;
                if (date.startsWith(currentMonth)) valMonth += seconds;
                if (date.startsWith(currentYear)) valYear += seconds;
            }
            
            document.getElementById('statToday').innerText = formatTime(valToday);
            document.getElementById('statMonth').innerText = formatTime(valMonth);
            document.getElementById('statYear').innerText = formatTime(valYear);
            document.getElementById('statTotal').innerText = formatTime(valTotal);
        }

        // æ‰‹åŠ¨ä¿®æ”¹ä»Šæ—¥æ—¶é•¿
        window.openStatModal = function() {
            const todayStr = new Date().toISOString().split('T')[0];
            const currentSeconds = focusHistory[todayStr] || 0;
            const minutes = Math.floor(currentSeconds / 60);
            document.getElementById('manualStatInput').value = minutes;
            document.getElementById('statModal').classList.add('show');
        };
        
        window.closeStatModal = function() {
            document.getElementById('statModal').classList.remove('show');
        };
        
        window.saveManualStat = function() {
            const input = document.getElementById('manualStatInput');
            const minutes = parseInt(input.value);
            if (isNaN(minutes) || minutes < 0) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†é’Ÿæ•°");
                return;
            }
            
            const todayStr = new Date().toISOString().split('T')[0];
            focusHistory[todayStr] = minutes * 60;
            saveHistory();
            updateStatsUI();
            closeStatModal();
        };

        // ç•ªèŒ„é’Ÿæ§åˆ¶
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer').innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function toggleTimer() {
            const btn = document.getElementById('startBtn');
            const circle = document.getElementById('pomoCircle');
            const settingsDiv = document.getElementById('timerSettings');
            
            if (isRunning) {
                clearInterval(timerInterval);
                btn.innerText = "START";
                circle.classList.remove('active');
                settingsDiv.classList.remove('disabled');
            } else {
                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();
                    
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        addToHistory(defaultTime);
                        document.getElementById('alarmModal').classList.add('show');
                        isRunning = false;
                        btn.innerText = "START";
                        circle.classList.remove('active');
                        settingsDiv.classList.remove('disabled');
                        playAlarm();
                    }
                }, 1000);
                btn.innerText = "PAUSE";
                circle.classList.add('active');
                settingsDiv.classList.add('disabled');
            }
            isRunning = !isRunning;
        }

        function resetTimer(fullReset = true) {
            clearInterval(timerInterval);
            isRunning = false;
            document.getElementById('startBtn').innerText = "START";
            const circle = document.getElementById('pomoCircle');
            circle.classList.remove('active');
            const settingsDiv = document.getElementById('timerSettings');
            settingsDiv.classList.remove('disabled');
            if (fullReset) updateCustomTime();
        }
        
        function updateCustomTime() {
            const minutes = parseInt(document.getElementById('customMinutes').value) || 25;
            defaultTime = minutes * 60;
            timeLeft = defaultTime;
            updateTimerDisplay();
        }
        
        function closeModal() {
            document.getElementById('alarmModal').classList.remove('show');
            updateCustomTime();
        }
        
        function playAlarm() {
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(1, audioCtx.currentTime + 0.1);
                gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1);
                
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 1);
            } catch (e) {
                console.error('æ— æ³•æ’­æ”¾æç¤ºéŸ³:', e);
            }
        }

        // --- éŸ³ä¹é€»è¾‘ ---
        function startVinyl() {
            document.getElementById('vinyl').classList.add('playing');
            setTimeout(() => { document.getElementById('vinyl').classList.remove('playing'); }, 5000);
        }

        // åˆå§‹åŒ–
        renderList();
        updateParentOptions();
        renderShortcuts();
        updateCustomTime();
        updateStatsUI();
        initDragAndDrop();
        renderCompletedTasks();
        if (currentTab === 'day') switchTab('day');
    </script>
</body>
</html>